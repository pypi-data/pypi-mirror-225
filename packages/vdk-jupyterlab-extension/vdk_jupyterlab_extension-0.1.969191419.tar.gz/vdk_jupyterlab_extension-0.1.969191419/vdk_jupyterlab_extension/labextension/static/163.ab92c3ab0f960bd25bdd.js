"use strict";(self.webpackChunkvdk_jupyterlab_extension=self.webpackChunkvdk_jupyterlab_extension||[]).push([[163],{163:(e,t,n)=>{n.r(t),n.d(t,{default:()=>ne,workingDirectory:()=>te});var o,a=n(38),r=n(271),s=n.n(r);!function(e){e.NAME="jobName",e.TEAM="jobTeam",e.PATH="jobPath",e.ARGUMENTS="jobArguments",e.DEPLOYMENT_REASON="deploymentReason"}(o||(o={}));var l=n(33),i=new Map([]);function c(){for(const e of Object.values(o))i.set(e,"")}function u(){return{jobName:i.get(o.NAME),jobTeam:i.get(o.TEAM),jobPath:i.get(o.PATH),jobArguments:i.get(o.ARGUMENTS),deploymentReason:i.get(o.DEPLOYMENT_REASON)}}async function d(e){return!!i.get(e)||(await(0,l.showErrorMessage)("Encountered an error while trying to execute operation. Error:","The "+e+" should be defined!",[l.Dialog.okButton()]),!1)}c();const h=e=>{const t=e.split(/(?=[/\\])/);return t[t.length-1]};class m extends r.Component{constructor(e){super(e),this.onInputChange=e=>{let t=e.currentTarget.value;t||(t=this.props.value),i.set(this.props.option,t)}}render(){return s().createElement(s().Fragment,null,s().createElement("div",{className:"jp-vdk-input-wrapper"},s().createElement("label",{className:"jp-vdk-label",htmlFor:this.props.option},this.props.label),s().createElement("input",{type:"text",id:this.props.option,className:"jp-vdk-input",placeholder:h(this.props.value),onChange:this.onInputChange})))}}var p=n(142),g=n(820);async function b(e="",t={}){const n=g.ServerConnection.makeSettings(),o=p.URLExt.join(n.baseUrl,"vdk-jupyterlab-extension",e);let a;try{a=await g.ServerConnection.makeRequest(o,t,n)}catch(e){throw e}let r=await a.text();if(r.length>0)try{r=JSON.parse(r)}catch(e){console.log("Not a JSON response body.",a)}if(!a.ok)throw new Error(a.statusText);return r}const v=async e=>{await(0,l.showErrorMessage)("Encountered an error while trying to connect the server. Error:",e,[l.Dialog.okButton()])};async function y(){if(!await d(o.PATH))return{message:"",status:!1};try{const e=await b("run",{body:JSON.stringify(u()),method:"POST"});return{message:e.message,status:"0"==e.message}}catch(e){return v(e),{message:"",status:!1}}}async function w(e){if(await d(o.NAME)&&await d(o.TEAM))try{const t=await b(e,{body:JSON.stringify(u()),method:"POST"});t.error?await(0,l.showErrorMessage)("Encountered an error while trying the "+e+" operation. Error:",t.message,[l.Dialog.okButton()]):alert(t.message)}catch(e){v(e)}}var f=n(502);const E="Convert Job To Notebook",k="Run Job",j="Create Deployment",T="Status",N="jp-vdk:check-status-button",A="Error",D="vdk-error-dialog";async function P(e){const{title:t,messages:n,error:o,buttons:a=[l.Dialog.okButton({label:"OK"})]}=e;return await(0,l.showDialog)({title:t,body:s().createElement("div",{className:D},s().createElement(f.closeIcon.react,{className:"vdk-dialog-error-icon"}),s().createElement("div",null,n.map(((e,t)=>s().createElement("p",{key:t},e)))," ",o&&s().createElement("p",null,o))),buttons:a})}class C{constructor(e){this.exception_message="",this.what_happened="",this.why_it_happened="",this.consequences="",this.countermeasures="",this.__parse_message(e)}__parse_message(e){const t=["exception_message","what_happened","why_it_happened","consequences","countermeasures"],n=["ERROR : ","WHAT HAPPENED :","WHY IT HAPPENED :","CONSEQUENCES :","COUNTERMEASURES :"],o=e.split("\n");let a=0;for(let r=0;r<o.length;r++){const s=o[r].indexOf(n[a]);if(-1!==s){if(this[t[a]]=n[a]+o[r].substring(s+n[a].length),a++,a===t.length)break}else this.exception_message=e}}}class _ extends r.Component{constructor(e){super(e),this._onArgsChange=e=>{let t=e.currentTarget.value;t&&this._isJSON(t)&&i.set(o.ARGUMENTS,t)},this._isJSON=e=>{try{return JSON.parse(e),!0}catch(e){return!1}}}render(){return s().createElement(s().Fragment,null,s().createElement(m,{option:o.PATH,value:this.props.jobPath,label:"Path to job directory:"}),s().createElement("div",{className:"jp-vdk-input-wrapper"},s().createElement("label",{className:"jp-vdk-label",htmlFor:"arguments"},"Arguments:"),s().createElement("input",{type:"text",id:"arguments",className:"jp-vdk-input",placeholder:'{"key": "value"}',onChange:this._onArgsChange})),s().createElement("ul",{id:"argumentsUl",className:"hidden"}))}}async function x(e,t){if((await(0,l.showDialog)({title:k,body:s().createElement(_,{jobPath:i.get(o.PATH)}),buttons:[l.Dialog.okButton(),l.Dialog.cancelButton()]})).button.accept){null==t||t.show("Run",i.get(o.PATH));let{message:n,status:a}=await y();if(a)(0,l.showDialog)({title:k,body:s().createElement("div",{className:"vdk-run-dialog-message-container"},s().createElement(f.checkIcon.react,{className:"vdk-dialog-check-icon"}),s().createElement("p",{className:"vdk-run-dialog-message"},"The job was executed successfully!")),buttons:[l.Dialog.okButton()]});else{n="ERROR : "+n;const t=new C(n);e&&await I(t,e)||await P({title:k,messages:[t.exception_message,t.what_happened,t.why_it_happened,t.consequences,t.countermeasures]})}}}const S=e=>{const t=e.getElementsByClassName("jp-Cell-inputWrapper");for(let e=0;e<t.length;e++){const n=t[e].getElementsByClassName("jp-Cell-inputArea");if(n.length>0){const e=n[0].getElementsByClassName("jp-InputArea-prompt");if(e.length>0)return e[0]}}},O=e=>{const t=S(e);null==t||t.classList.add("jp-vdk-failing-cell-prompt"),e.scrollIntoView(),e.classList.add("jp-vdk-failing-cell"),Array.from(document.getElementsByClassName("jp-vdk-failing-cell-num")).forEach((e=>{e.classList.remove("jp-vdk-failing-cell-num"),e.classList.add("jp-vdk-cell-num")}))},M=e=>{e.classList.remove("jp-vdk-failing-cell");const t=S(e);null==t||t.classList.remove("jp-vdk-failing-cell-prompt")},I=async(e,t)=>{const n=(e=>{const t=e.match(/cell_id:([0-9a-fA-F-]+)/);return t?t[1]:""})(e.what_happened);if(n){const{path:a,cellIndex:r}=await async function(e){const t={cellId:e,jobPath:i.get(o.PATH)};if(!await d(o.PATH))return{path:"",cellIndex:""};try{const e=await b("notebook",{body:JSON.stringify(t),method:"POST"});return{path:e.path,cellIndex:e.cellIndex}}catch(e){return{path:"",cellIndex:""}}}(n);if(a){const n=async()=>{const e=t.openOrReveal(a);if(e){await e.revealed;const t=Array.from(e.node.children);t&&t.forEach((async e=>{e.classList.contains("jp-Notebook")&&(async(e,t,n)=>{const o=e.children;if(t>o.length)(0,l.showDialog)({title:"Run Failed",body:s().createElement("div",null,s().createElement("p",null,"Sorry, something went wrong while trying to find the failing cell!"),s().createElement("p",null,"Please, check the ",n," once more and try to run the job while the notebook is active!")),buttons:[l.Dialog.cancelButton()]});else for(let e=0;e<o.length;e++)e===t?O(o[e]):M(o[e])})(e,Number(r),a)}))}};return(await P({title:k,messages:[e.exception_message,e.what_happened,e.why_it_happened,e.consequences,e.countermeasures],buttons:[l.Dialog.okButton({label:"See failing cell"}),l.Dialog.cancelButton()]})).button.accept&&await n(),!0}}return!1};class H extends r.Component{constructor(e){super(e)}render(){return s().createElement(s().Fragment,null,s().createElement(m,{option:o.NAME,value:this.props.jobName,label:"Job Name:"}),s().createElement(m,{option:o.TEAM,value:this.props.jobTeam,label:"Job Team:"}),s().createElement(m,{option:o.PATH,value:this.props.jobPath,label:"Path to job directory:"}),s().createElement(m,{option:o.DEPLOYMENT_REASON,value:"reason",label:"Deployment reason:"}))}}async function B(e){const t=await(0,l.showDialog)({title:j,body:s().createElement(H,{jobName:i.get(o.NAME),jobPath:i.get(o.PATH),jobTeam:i.get(o.TEAM)}),buttons:[l.Dialog.okButton(),l.Dialog.cancelButton()]});if(!t.value&&t.button.accept)try{if((await(0,l.showDialog)({title:j,body:"The job will be executed once before deployment.",buttons:[l.Dialog.cancelButton({label:"Cancel"}),l.Dialog.okButton({label:"Continue"})]})).button.accept){null==e||e.show("Deploy",i.get(o.PATH));const{message:t,status:n}=await y();n?await d(o.DEPLOYMENT_REASON)&&await w("deploy"):await P({title:j,messages:["Encountered an error while running the job!"],error:t})}}catch(e){await P({title:j,messages:["Encountered an error when deploying the job. Error:"],error:e})}}class J extends r.Component{constructor(e){super(e)}render(){return s().createElement(s().Fragment,null,s().createElement(m,{option:o.NAME,value:this.props.jobName,label:"Job Name:"}),s().createElement(m,{option:o.TEAM,value:this.props.jobTeam,label:"Job Team:"}),s().createElement(m,{option:o.PATH,value:this.props.jobPath,label:"Path to job directory:"}))}}async function R(){(await(0,l.showDialog)({title:"Create Job",body:s().createElement(J,{jobPath:i.get(o.PATH),jobName:i.get(o.NAME),jobTeam:i.get(o.TEAM)}),buttons:[l.Dialog.okButton(),l.Dialog.cancelButton()]})).button.accept&&await w("create")}class L extends r.Component{constructor(e){super(e)}render(){return s().createElement(s().Fragment,null,s().createElement(m,{option:o.NAME,value:"default-name",label:"Job Name:"}),s().createElement(m,{option:o.TEAM,value:"default-team",label:"Job Team:"}),s().createElement(m,{option:o.PATH,value:this.props.jobPath,label:"Path to job directory:"}))}}async function K(e){(await(0,l.showDialog)({title:"Download Job",body:s().createElement(L,{jobPath:i.get(o.PATH)}),buttons:[l.Dialog.okButton(),l.Dialog.cancelButton()]})).button.accept&&(null==e||e.show("Download",i.get(o.PATH)),await w("download"))}var V;class W extends r.Component{constructor(e){super(e)}render(){return s().createElement(s().Fragment,null,s().createElement(m,{option:o.PATH,value:this.props.jobPath,label:"Path to job directory:"}))}}async function q(e,t,n,a){if((await(0,l.showDialog)({title:E,body:s().createElement(W,{jobPath:i.get(o.PATH)}),buttons:[l.Dialog.okButton(),l.Dialog.cancelButton()]})).button.accept&&(await(0,l.showDialog)({title:E,body:s().createElement("p",null,"Are you sure you want to convert the Data Job with path:"," ",s().createElement("i",null,i.get(o.PATH))," to notebook?"),buttons:[l.Dialog.okButton(),l.Dialog.cancelButton()]})).button.accept){null==a||a.show("Convert",i.get(o.PATH));let{message:r,status:c}=await async function(){if(!await d(o.PATH))return{message:"The job path is not defined. Please define it before attempting to convert the job to a notebook.",status:!1};try{const e=await b("convertJobToNotebook",{body:JSON.stringify(u()),method:"POST"});return{message:e.message,status:""==e.error}}catch(e){return v(e),{message:"",status:!1}}}();if(c){const a=JSON.parse(r);V=U(a.code_structure,a.removed_files),await F(e,t,n),await(0,l.showDialog)({title:E,body:s().createElement("div",{className:"vdk-convert-to-notebook-dialog-message-container"},s().createElement(f.checkIcon.react,{className:"vdk-dialog-check-icon"}),s().createElement("p",{className:"vdk-convert-to-notebook-dialog-message"},"The Data Job with path ",s().createElement("i",null,i.get(o.PATH))," was converted to notebook successfully!")),buttons:[l.Dialog.okButton()]})}else if(r){r="ERROR : "+r;const e=new C(r);await P({title:E,messages:[e.exception_message,e.what_happened,e.why_it_happened,e.consequences,e.countermeasures]})}}}const F=async(e,t,n)=>{try{const n=await async function(){return await b("serverPath",{method:"GET"})||(await(0,l.showErrorMessage)("Encountered an error while trying to connect the server. Error:       the server's location cannot be identified!",[l.Dialog.okButton()]),"")}();i.set(o.NAME,i.get(o.PATH).split(/[\\/]/).pop()||""),await t.model.cd(i.get(o.PATH).substring(n.length)),e.execute("notebook:create-new")}catch(e){await P({title:E,messages:["Something went wrong while trying to create the new transformed notebook. Error:"],error:e})}},U=(e,t)=>{const n=[];for(let o=0;o<e.length;o++)n.push({source:"#### "+t[o],type:"markdown"}),n.push({source:e[o],type:"code"}),e[o].includes("def run(job_input: IJobInput)")&&n.push({source:"run(job_input)",type:"code"});return n};var Y="";function G(e,t,n,a,r,s,l,d,h){e.addCommand(t,{label:n,caption:a,execute:async()=>{try{Y?await P({title:A,messages:["Another VDK operation is currently running!","Please wait until the operation ends!"]}):(Y=t,i.set(o.PATH,te),await async function(){try{const e=await b("job",{body:JSON.stringify(JSON.stringify(u())),method:"POST"});e&&(i.set(o.NAME,e[o.NAME]),i.set(o.TEAM,e[o.TEAM]),i.set(o.PATH,e[o.PATH]))}catch(e){v(e)}}(),"Convert Job To Notebook"===n?await r(e,d,h,s):l?await r(l,s):await r(s),s.hide(),c(),Y="")}catch(e){await P({title:A,messages:["Encountered an error when trying to open the dialog. Error:"],error:e})}}})}var z=n(280),Q=n(123);const $=(e,t)=>{const n=document.createElement("div");n.innerText=String(e),t.classList.contains("jp-vdk-failing-cell")?n.classList.add("jp-vdk-failing-cell-num"):n.classList.add("jp-vdk-cell-num"),t.appendChild(n)},X=e=>{const t=document.createElement("img");t.setAttribute("src","https://raw.githubusercontent.com/vmware/versatile-data-kit/dc15f7489f763a0e0e29370b2e06a714448fc234/support/images/versatile-data-kit-logo.svg"),t.setAttribute("width","20"),t.setAttribute("height","20"),t.classList.add("jp-vdk-logo"),e.appendChild(t)};var Z=n(986);class ee{constructor(e){this.buttonElement=document.createElement("button"),this.buttonElement.id="jp-vdk-check-status-button",this.buttonElement.className="jp-vdk-check-status-button";const t=document.createElement("div");t.className="jp-vdk-status-button-content",X(t);const n=document.createElement("span");n.innerHTML="00:00:00",t.appendChild(n),this.buttonElement.appendChild(t),this.buttonElement.onclick=()=>{e.execute(N,{operation:this.operation,path:this.jobPath})},this.buttonElement.title="VDK operation is in progress. Click here for more info.",this.buttonElement.style.display="none",this.counter=0}get element(){return this.buttonElement}show(e,t){this.operation=e,this.jobPath=t,this.buttonElement.style.display="",this.startTimer()}hide(){this.buttonElement.style.display="none",this.stopTimer()}startTimer(){this.counter=0,this.timerId=window.setInterval((()=>{this.counter++;const e=this.buttonElement.querySelector("span");var t;e&&(e.innerHTML=`${t=this.counter,new Date(1e3*t).toISOString().substr(11,8)}`)}),1e3)}stopTimer(){this.timerId&&(clearInterval(this.timerId),this.timerId=void 0);const e=this.buttonElement.querySelector("span");e&&(e.innerHTML="00:00:00")}}let te="";const ne={id:"vdk-jupyterlab-extension:plugin",autoStart:!0,optional:[a.ISettingRegistry,z.IFileBrowserFactory,Q.INotebookTracker,l.IThemeManager,Z.IDocumentManager],activate:async(e,t,n,a,r,c)=>{const{commands:u}=e;a.activeCellChanged.connect(((e,t)=>{"jp-vdk:menu-convert-job-to-notebook"!==Y?function(e){var t,n,o,a;const r=e.currentWidget;if(r){const s=null===(n=null===(t=r.content.model)||void 0===t?void 0:t.contentFactory)||void 0===n?void 0:n.createCodeCell({cell:{cell_type:"code",source:['"""\n',"vdk.plugin.ipython extension introduces a magic command for Jupyter.\n","The command enables the user to load VDK for the current notebook.\n","VDK provides the job_input API, which has methods for:\n","    * executing queries to an OLAP database;\n","    * ingesting data into a database;\n","    * processing data into a database.\n","See the IJobInput documentation for more details.\n","https://github.com/vmware/versatile-data-kit/blob/main/projects/vdk-core/src/vdk/api/job_input.py\n","Please refrain from tagging this cell with VDK as it is not an actual part of the data job\n","and is only used for development purposes.\n",'"""\n',"%reload_ext vdk.plugin.ipython\n","%reload_VDK\n","job_input = VDK.get_initialized_job_input()"],metadata:{}}}),l=null===(a=null===(o=e.currentWidget)||void 0===o?void 0:o.content.model)||void 0===a?void 0:a.cells,i=null==l?void 0:l.get(0).value.text;l&&s&&l.length<=1&&""==i&&(l.insert(0,s),l.remove(1))}}(a):(async e=>{var t,n;const a=e.currentWidget;if(a){const r=null===(n=null===(t=e.currentWidget)||void 0===t?void 0:t.content.model)||void 0===n?void 0:n.cells,s=null==r?void 0:r.get(0).value.text;if(r&&r.length<=1&&""==s){r.remove(1);const e=e=>{var t,n;const o=null===(n=null===(t=a.content.model)||void 0===t?void 0:t.contentFactory)||void 0===n?void 0:n.createMarkdownCell({cell:{cell_type:"markdown",source:e,metadata:{}}});o&&r.push(o)},t=(e,t)=>{var n,o;const s=null===(o=null===(n=a.content.model)||void 0===n?void 0:n.contentFactory)||void 0===o?void 0:o.createCodeCell({cell:{cell_type:"code",source:e,metadata:t}});s&&r.push(s)};e(["# "+i.get(o.NAME)]),e(["### Please go through this guide before continuing with the data job run and development."]),e(["#### Introduction and Preparations\n","*  *This is a notebook transformed from a directory style data job located in "+i.get(o.PATH)+".*\n","*  *If you are not familiar with notebook data jobs make sure to check the **Getting Started**(TODO: add link) page.*\n","*  *You can find the **original job** at "+i.get(o.PATH).split(/[/\\]/).slice(0,-1).join("/")+".*"]),e(["#### Execution Order and Identifying Cells\n","*  *The below cells are automatically generated corresponding to a step(.sql or .py file with VDK run function) \n","    in your original job.* \n","*  *You will notice that some cells are coloured and include the VDK logo and a numbering. \n",'    These are the "vdk" tagged cells.\n',"    Only these cells are executed during VDK run and all the others are ignored(for example the current cell).*\n","*  *Code cells in the notebook will be executed according to the numbering when running the notebook data job with VDK.\n","    This means that the steps in the job are organized from the top to the bottom, starting with the first step.*\n",'*  *When you see a title saying **"Step generated from: sample.py"** before some blocks of code, \n','    it means that the code below that title was created from the "sample.py" file.*\n','*  *Similarly, if you come across code cells that have the format **"job_input.execute_query(query_string)"** ,\n','    it means that those cells contain code generated from ".sql" files.*\n','*  *On the other hand, code cells originating from ".py" files remain unchanged.\n','    However, an additional cell is included that calls the "run" function using the command **"run(job_input)"** . \n','    This cell executes the "run" function from the code generated from the ".py" file.*\n','*  *You can delete the cells that are not tagged with "vdk" \n',"    as they are not essential to the data job's execution.\n","    However, removing tagged cells will result in a different data job run.* "]),e(["#### Tips: \n","* *Before running the job, it is recommended to review the cells\n","    to ensure a clear understanding of the data job run.  \n","    This will help to ensure the desired outcome.* "]),t(['"""\n',"vdk.plugin.ipython extension introduces a magic command for Jupyter.\n","The command enables the user to load VDK for the current notebook.\n","VDK provides the job_input API, which has methods for:\n","    * executing queries to an OLAP database;\n","    * ingesting data into a database;\n","    * processing data into a database.\n","See the IJobInput documentation for more details.\n","https://github.com/vmware/versatile-data-kit/blob/main/projects/vdk-core/src/vdk/api/job_input.py\n","Please refrain from tagging this cell with VDK as it is not an actual part of the data job\n","and is only used for development purposes.\n",'"""\n',"%reload_ext vdk.plugin.ipython\n","%reload_VDK\n","job_input = VDK.get_initialized_job_input()"],{});for(const n of V)"markdown"===n.type?e([n.source]):"code"===n.type&&t([n.source],{tags:["vdk"]});V=[]}}})(a)})),function(e){e.addCommand(N,{label:T,icon:f.checkIcon,execute:async e=>{const t=e.operation||"UNKNOWN",n=e.path||"UNKNOWN";await(0,l.showDialog)({title:T,body:s().createElement("div",{className:"vdk-status-dialog-message-container"},s().createElement("p",{className:"vdk-status-dialog-message"},s().createElement("b",null,t)," operation is currently running for job with path: ",s().createElement("i",null,n),"!")),buttons:[l.Dialog.okButton()]})}})}(u);const d=function(e){return new ee(e)}(u),h=n.defaultBrowser;e.restored.then((()=>{const e=document.querySelector("#jp-top-panel");e&&e.appendChild(d.element)})),function(e,t,n,o,a){G(e,"jp-vdk:menu-run","Run","Execute VDK Run Command",x,a,t),G(e,"jp-vdk:menu-create","Create","Execute VDK Create Command",R,a),G(e,"jp-vdk:menu-download","Download","Execute VDK Download Command",K,a),G(e,"jp-vdk:menu-convert-job-to-notebook","Convert Job To Notebook","Convert Data Job To Jupyter Notebook",q,a,void 0,n,o),G(e,"jp-vdk:menu-create-deployment","Deploy","Create deployment of a VDK job",B,a)}(u,c,h,a,d),h.model.pathChanged.connect(oe),((e,t)=>{const n=async()=>{if(e.currentWidget&&e.currentWidget.model&&0!==e.currentWidget.model.cells.length){let n=[],o=0;for(;e.currentWidget&&e.currentWidget.model&&e.currentWidget.model.cells.get(o);){const t=e.currentWidget.model.cells.get(o).metadata.get("tags");t&&t.includes("vdk")&&n.push(o),o++}n.length||(n=await async function(e){try{const t={nbPath:e};return await b("vdkCellIndices",{body:JSON.stringify(t),method:"POST"})}catch(e){v(e)}return[]}(e.currentWidget.context.path)),n.length>0&&e.activeCell&&e.activeCell.parent&&e.activeCell.parent.node.children&&((e,t,n,o)=>{Array.from(document.getElementsByClassName("jp-vdk-cell-num")).forEach((e=>{e.remove()})),Array.from(document.getElementsByClassName("jp-vdk-failing-cell-num")).forEach((e=>{e.remove()})),Array.from(document.getElementsByClassName("jp-vdk-logo")).forEach((e=>{e.remove()}));let a=0;for(let r=0;r<e.length;r++)t.includes(r)?(n.theme&&n.isLight(n.theme.toString())?(e[r].classList.remove("jp-vdk-cell-dark"),e[r].classList.add("jp-vdk-cell")):(e[r].classList.add("jp-vdk-cell"),e[r].classList.add("jp-vdk-cell-dark")),o&&e[r]!=o&&X(e[r]),$(++a,e[r])):(e[r].classList.remove("jp-vdk-cell"),e[r].classList.remove("jp-vdk-cell-dark"))})(Array.from(e.activeCell.parent.node.children),n,t,e.activeCell.node)}};e.activeCellChanged.connect(n),t.themeChanged.connect(n)})(a,r)}},oe=async(e,t)=>{te=t.newValue}}}]);