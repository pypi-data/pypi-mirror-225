import{r as p,$ as ee,j as e,u as Y,n as Q,H as se,q as P,d as V,i as Te,t as c,I as Ne,w as U,e as q,s as C,S as Ce,B as ne,z as ce,v as je,c as $,J as ke,A as Oe,m as Ee,o as Fe,K as Be,p as Me,P as ge,Q as pe,D as Pe,R as Ie,E as ie,G as ze,F as $e}from"./index-ff1743b2.js";import{D as Ge,I as He,y as Ue,o as oe,r as We,a as Re,p as Le,g as Ve,i as Qe,R as qe,X as _e,$ as me}from"./transition-65d8b341.js";import{b as Ke,M as Ye,_ as Se}from"./dialog-9c75ff50.js";import{u as J,g as Je,E as K,i as Xe,a as le,b as ye,c as h,P as Ze}from"./context-d92d8d28.js";import{M as es,H as ss,P as H}from"./PlanChangePreview-e614eaad.js";import{B as Z}from"./Banner-724289b7.js";import{T as he}from"./TasksOverview-e2a0cfc3.js";import{v as M,M as de,P as ue}from"./disclosure-8eea5612.js";import ns from"./ReportErrors-0bc7013b.js";import{I as te}from"./Input-f36d2f96.js";import{s as ls}from"./popover-a777e0dc.js";import{T as as,p as ts}from"./use-controllable-2f233ce4.js";import{S as rs}from"./SplitPane-47f32831.js";import"./context-e4b03e9a.js";import"./_commonjs-dynamic-modules-302442b1.js";import"./ModelLineage-29146895.js";import"./Graph-12643de8.js";import"./extends-98964cd2.js";import"./pluralize-1a9dd2e8.js";let be=p.createContext(null);be.displayName="GroupContext";let is=p.Fragment;function os(n){var s;let[a,t]=p.useState(null),[i,r]=ss(),[j,d]=Ye(),b=p.useMemo(()=>({switch:a,setSwitch:t,labelledby:i,describedby:j}),[a,t,i,j]),m={},w=n;return ee.createElement(d,{name:"Switch.Description"},ee.createElement(r,{name:"Switch.Label",props:{htmlFor:(s=b.switch)==null?void 0:s.id,onClick(u){a&&(u.currentTarget.tagName==="LABEL"&&u.preventDefault(),a.click(),a.focus({preventScroll:!0}))}}},ee.createElement(be.Provider,{value:b},_e({ourProps:m,theirProps:w,defaultTag:is,name:"Switch.Group"}))))}let cs="button";function ds(n,s){let a=He(),{id:t=`headlessui-switch-${a}`,checked:i,defaultChecked:r=!1,onChange:j,name:d,value:b,form:m,...w}=n,u=p.useContext(be),g=p.useRef(null),E=Ue(g,s,u===null?null:u.setSwitch),[f,o]=as(i,j,r),_=oe(()=>o==null?void 0:o(!f)),D=oe(y=>{if(We(y.currentTarget))return y.preventDefault();y.preventDefault(),_()}),B=oe(y=>{y.key===Re.Space?(y.preventDefault(),_()):y.key===Re.Enter&&ts(y.currentTarget)}),v=oe(y=>y.preventDefault()),A=p.useMemo(()=>({checked:f}),[f]),R={id:t,ref:E,role:"switch",type:ls(n,g),tabIndex:0,"aria-checked":f,"aria-labelledby":u==null?void 0:u.labelledby,"aria-describedby":u==null?void 0:u.describedby,onClick:D,onKeyUp:B,onKeyPress:v},I=Le();return p.useEffect(()=>{var y;let W=(y=g.current)==null?void 0:y.closest("form");W&&r!==void 0&&I.addEventListener(W,"reset",()=>{o(r)})},[g,o]),ee.createElement(ee.Fragment,null,d!=null&&f&&ee.createElement(Ve,{features:Qe.Hidden,...qe({as:"input",type:"checkbox",hidden:!0,readOnly:!0,form:m,checked:f,name:d,value:b})}),_e({ourProps:R,theirProps:w,slot:A,defaultTag:cs,name:"Switch"}))}let us=Ge(ds),ps=os,fe=Object.assign(us,{Group:ps,Label:es,Description:Ke});function ms({show:n,children:s,afterLeave:a,onClose:t=()=>{}}){return e.jsx(me,{appear:!0,show:n,as:p.Fragment,afterLeave:a,children:e.jsxs(Se,{as:"div",className:"relative z-[100] w-full h-full ",onClose:t,children:[e.jsx(me.Child,{as:p.Fragment,enter:"ease-out duration-300",enterFrom:"bg-overlay opacity-0",enterTo:"bg-overlay opacity-80",leave:"ease-in duration-200",leaveFrom:"bg-overlay opacity-80",leaveTo:"bg-overlay opacity-0",children:e.jsx("div",{className:"fixed inset-0"})}),e.jsx("div",{className:"w-full h-full fixed inset-0",children:e.jsx(me.Child,{as:p.Fragment,enter:"ease-out duration-300",enterFrom:"translate-x-[100%]",enterTo:"translate-x-0",leave:"ease-in duration-200",leaveFrom:"translate-x-0",leaveTo:"translate-x-[100%]",children:s})})]})})}function De({report:n}){return e.jsxs("div",{children:[e.jsxs("div",{className:"py-2",children:[e.jsxs("p",{children:["Total: ",n.total]}),e.jsxs("p",{children:["Succeeded: ",n.successful]}),e.jsxs("p",{children:["Failed: ",n.failures]}),e.jsxs("p",{children:["Errors: ",n.errors]}),e.jsxs("p",{children:["Dialect: ",n.dialect]})]}),e.jsx("ul",{children:n.details.map(s=>e.jsxs("li",{className:"flex mb-1",children:[e.jsx("span",{className:"inline-block mr-4",children:"â€”"}),e.jsxs("div",{className:"overflow-hidden",children:[e.jsx("span",{className:"inline-block mb-2",children:s.message}),e.jsx("code",{className:"inline-block max-h-[50vh] bg-theme py-2 px-4 rounded-lg w-full overflow-auto scrollbar scrollbar--vertical scrollbar--horizontal",children:e.jsx("pre",{children:s.details})})]})]},s.message))})]})}function hs({setRefTasksOverview:n}){const{backfills:s,hasChanges:a,hasBackfills:t,activeBackfill:i,modified:r,added:j,removed:d,virtualUpdateDescription:b,skip_backfill:m,skip_tests:w,change_categorization:u,hasVirtualUpdate:g,testsReportErrors:E,testsReportMessages:f}=J(),o=Y(x=>x.environment),_=Q(x=>x.state),D=Q(x=>x.action),B=p.useMemo(()=>Array.from(u.values()).reduce((x,{category:N,change:k})=>{var S;return(S=k==null?void 0:k.indirect)==null||S.forEach(T=>{var z;x[T]==null&&(x[T]=[]),(z=x[T])==null||z.push(N.value!==1)}),N.value===3&&(x[k.model_name]=[!0]),x},{}),[u]),v=p.useCallback(x=>Object.entries(x).reduce((N,[k,S])=>{const T=B[k];return(T!=null?T.every(Boolean):!1)||(N[k]=S),N},{}),[B]),A=p.useCallback(x=>x.reduce((N,k)=>{const S=k.model_name,T=k.interval,z={completed:0,total:k.batches,interval:T,view_name:k.view_name},L=B[S];return(L!=null?L.every(Boolean):!1)||(N[S]=z),N},{}),[B]),R=p.useMemo(()=>(i==null?void 0:i.tasks)!=null?v(i.tasks):A(s),[s,u,i]),I=_===C.Finished,y=[a,t,se(R)].every(P),W=g&&P(I)||P(y)&&t&&P(m)&&V(Object.keys(R)),G=Je({planAction:D,planState:_,hasBackfills:t,hasVirtualUpdate:g,hasNoChanges:y||Te(Object.keys(R)),skip_backfill:m});return e.jsx("div",{className:"w-full h-full overflow-hidden overflow-y-auto p-4 scrollbar scrollbar--vertical",children:e.jsx("ul",{className:"w-full",children:D===c.Run?e.jsx(F.StepOptions,{className:"w-full"}):e.jsxs(e.Fragment,{children:[e.jsx(xe,{headline:"Tests",description:"Report",disabled:o==null,children:D===c.Running?e.jsx(ae,{hasSpinner:!0,children:"Running Tests ..."}):Ne(E)&&Ne(f)?e.jsx(ae,{children:w?"Tests Skipped":"No Tests"}):e.jsxs(e.Fragment,{children:[E!=null&&e.jsx(Z,{variant:U.Danger,children:se(E)&&e.jsx(De,{report:E})}),f!=null&&e.jsx(Z,{variant:U.Success,children:se(f)&&e.jsx("div",{children:f.message})})]})}),e.jsx(xe,{headline:"Models",description:"Review Changes",disabled:o==null,children:a?e.jsxs(e.Fragment,{children:[(V(j)||V(d))&&e.jsxs("div",{className:"flex",children:[V(j)&&e.jsx(H,{className:"w-full m-2 max-h-[30vh]",headline:"Added Models",type:K.Add,children:e.jsx(H.Default,{type:K.Add,changes:j})}),V(d)&&e.jsx(H,{className:"w-full m-2 max-h-[30vh]",headline:"Removed Models",type:K.Remove,children:e.jsx(H.Default,{type:K.Remove,changes:d})})]}),Xe(r)&&e.jsxs(e.Fragment,{children:[V(r==null?void 0:r.direct)&&e.jsx(H,{className:"m-2 max-h-[30vh]",headline:"Modified Directly ",type:K.Direct,children:e.jsx(H.Direct,{changes:r.direct??[]})}),V(r.indirect)&&e.jsx(H,{className:"m-2 max-h-[30vh]",headline:"Modified Indirectly",type:K.Indirect,children:e.jsx(H.Indirect,{changes:r.indirect??[]})}),V(r==null?void 0:r.metadata)&&e.jsx(H,{className:"m-2 max-h-[30vh]",headline:"Modified Metadata",type:K.Metadata,children:e.jsx(H.Default,{type:K.Metadata,changes:(r==null?void 0:r.metadata)??[]})})]})]}):D===c.Running?e.jsx(ae,{hasSpinner:!0,children:"Checking Models..."}):e.jsx(ae,{children:"No Changes"})}),e.jsx(xe,{headline:"Backfill",description:"Progress",disabled:o==null,children:e.jsx(M,{defaultOpen:t,children:({open:x})=>e.jsxs(e.Fragment,{children:[e.jsx(ae,{hasSpinner:P(x)&&(D===c.Running||D===c.Applying),children:e.jsxs("div",{className:"flex justify-between items-center w-full",children:[e.jsx("div",{className:"flex items-center",children:e.jsx("h3",{className:q(_===C.Cancelled&&"text-prose",_===C.Failed&&"text-danger-700",_===C.Finished&&"text-success-700"),children:G})}),W&&e.jsxs("div",{className:"flex items-center",children:[e.jsx("p",{className:"mr-2 text-sm",children:"Details"}),e.jsx(M.Button,{className:"flex items-center justify-between rounded-lg text-left text-sm",children:x?e.jsx(de,{className:"h-6 w-6 text-primary-500"}):e.jsx(ue,{className:"h-6 w-6 text-primary-500"})})]})]})}),e.jsxs(M.Panel,{className:"px-4 pb-2 text-sm",children:[t&&P(m)&&V(Object.keys(R))&&e.jsx(e.Fragment,{children:e.jsx(p.Suspense,{fallback:e.jsx(Ce,{className:"w-4 h-4 mr-2"}),children:e.jsx(he,{tasks:R,setRefTasksOverview:n,children:({total:N,completed:k,models:S,completedBatches:T,totalBatches:z})=>e.jsxs(e.Fragment,{children:[e.jsx(he.Summary,{environment:o.name,planState:_,headline:"Target Environment",completed:k,total:N,completedBatches:T,totalBatches:z,updateType:g?"Virtual":"Backfill",updatedAt:i==null?void 0:i.updated_at}),S!=null&&e.jsx(he.Details,{models:S,changes:{modified:r,added:j,removed:d},showBatches:t,showVirtualUpdate:g,showProgress:!0})]})})})}),g&&e.jsx("div",{children:e.jsx("small",{className:"text-sm",children:b})})]})]})},G)})]})})})}function ae({hasSpinner:n=!1,children:s}){return e.jsx("span",{className:"mt-1 mb-4 px-4 py-2 bg-primary-10 flex w-full rounded-lg",children:e.jsxs("span",{className:"flex items-center w-full",children:[n&&e.jsx(Ce,{className:"w-4 h-4 mr-2"}),s]})})}function xe({headline:n,description:s,children:a,disabled:t=!1}){return e.jsxs("li",{className:"mb-2 p-4",children:[e.jsx(fs,{className:"min-w-[25%] pr-12",headline:n,disabled:t,children:s}),!t&&a]})}function fs({disabled:n=!1,headline:s,children:a,className:t}){return e.jsxs("div",{className:q(n&&"opacity-40 cursor-not-allowed","mb-4 ",t),children:[s!=null&&e.jsx("h3",{className:"whitespace-nowrap font-bold text-lg",children:s}),a!=null&&e.jsx("small",{className:"whitespace-nowrap",children:a})]})}function xs(){const n=Y(a=>a.environment),{testsReportErrors:s}=J();return e.jsxs("div",{className:"flex flex-col py-2 w-full",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("h4",{className:"text-xl pb-2 px-6",children:[e.jsx("span",{className:"font-bold",children:"Target Environment is"}),e.jsx("b",{className:"ml-2 px-2 py-1 font-sm rounded-md bg-primary-10 text-primary-500",children:n.name})]}),e.jsx("div",{className:"px-6",children:e.jsx(ns,{})})]}),e.jsxs("div",{className:"w-full h-full overflow-auto scrollbar scrollbar--vertical px-6 ",children:[n.isInitial&&n.isDefault&&e.jsx(Z,{variant:U.Warning,children:e.jsx(M,{defaultOpen:!0,children:({open:a})=>e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(Z.Headline,{className:"w-full mr-2 text-sm mb-0",children:"Initializing Prod Environment"}),e.jsx(M.Button,{className:"flex items-center justify-between rounded-lg text-left text-sm",children:a?e.jsx(de,{className:"h-6 w-6 text-warning-500"}):e.jsx(ue,{className:"h-6 w-6 text-warning-500"})})]}),e.jsx(M.Panel,{className:"px-4 pb-2 text-sm mt-2",children:e.jsx(Z.Description,{children:"Prod will be completely backfilled in order to ensure there are no data gaps. After this is applied, it is recommended to validate further changes in a dev environment before deploying to production."})})]})})}),s!=null&&se(s)&&e.jsx(Z,{variant:U.Danger,children:e.jsx(M,{defaultOpen:!1,children:({open:a})=>e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("p",{className:"w-full mr-2 text-sm",children:s==null?void 0:s.title}),e.jsx(M.Button,{className:"flex items-center justify-between rounded-lg text-left text-sm",children:a?e.jsx(de,{className:"h-6 w-6 text-danger-500"}):e.jsx(ue,{className:"h-6 w-6 text-danger-500"})})]}),e.jsx(M.Panel,{className:"px-4 pb-2 text-sm",children:e.jsx(De,{report:s})})]})})})]})]})}function js(n=0){return p.useCallback(s=>{setTimeout(()=>{s==null||s.focus()},n)},[n])}function gs({planAction:n,disabled:s,run:a,apply:t,cancel:i,close:r,reset:j}){const{start:d,end:b,hasBackfills:m,skip_tests:w,auto_apply:u,skip_backfill:g,no_gaps:E,no_auto_categorization:f,forward_only:o,restate_models:_,hasVirtualUpdate:D}=J(),B=Y(O=>O.environment),v=js(),A=n===c.None,R=n===c.Run,I=n===c.Done,y=n===c.Cancelling,W=n===c.Apply,G=n===c.Applying,x=n===c.Running,N=x||G||y;function k(O){O.stopPropagation(),r()}function S(O){O.stopPropagation(),j()}function T(O){O.stopPropagation(),i()}function z(O){O.stopPropagation(),t()}function L(O){O.stopPropagation(),a()}const re=m&&P(g);return e.jsxs("div",{className:"flex justify-between px-4 py-2",children:[e.jsxs("div",{className:"flex w-full items-center",children:[(R||x)&&e.jsxs(ne,{disabled:x||s,onClick:L,autoFocus:!0,ref:v,variant:U.Primary,children:[e.jsx("span",{children:le(n,[c.Running,c.Run])}),w&&e.jsx("span",{className:"inline-block ml-1",children:"And Skip Test"}),u&&e.jsx("span",{className:"inline-block ml-1",children:"And Auto Apply"})]}),(W||G)&&e.jsx(ne,{onClick:z,disabled:G||s,ref:v,variant:U.Primary,children:le(n,[c.Applying],re?"Apply And Backfill":D?"Apply Virtual Update":"Apply")}),N&&e.jsx(ne,{onClick:T,variant:U.Danger,className:"justify-self-end",disabled:y||s,children:le(n,[c.Cancelling],"Cancel")}),(R||x||W||G)&&e.jsxs("p",{className:"ml-2 text-xs max-w-sm",children:[e.jsx("span",{children:"Plan for"}),e.jsx("b",{className:"text-primary-500 font-bold mx-1",children:B.name}),e.jsx("span",{className:"inline-block mr-1",children:"environment"}),e.jsxs("span",{className:"inline-block mr-1",children:["from"," ",e.jsx("b",{children:P(ce(d))?d:"the begining of history"})]}),e.jsxs("span",{className:"inline-block mr-1",children:["till ",e.jsx("b",{children:P(ce(d))?b:"today"})]}),E&&e.jsxs("span",{className:"inline-block mr-1",children:["with ",e.jsx("b",{children:"No Gaps"})]}),g&&e.jsxs("span",{className:"inline-block mr-1",children:["without ",e.jsx("b",{children:"Backfills"})]}),o&&e.jsxs("span",{className:"inline-block mr-1",children:["consider as a ",e.jsx("b",{children:"Breaking Change"})]}),f&&e.jsxs("span",{className:"inline-block mr-1",children:["also set ",e.jsx("b",{children:"Change Category"})," manually"]}),P(ce(_))&&e.jsxs("span",{className:"inline-block mr-1",children:["and restate folowing models ",e.jsx("b",{children:_})]})]})]}),e.jsxs("div",{className:"flex items-center",children:[(A||[N,R,s,B.isInitial&&B.isDefault,I].every(P))&&e.jsx(ne,{onClick:S,variant:U.Neutral,disabled:je([c.Resetting,c.Running,c.Applying,c.Cancelling],n)||s,children:le(n,[c.Resetting],"Start Over")}),e.jsx(ne,{onClick:k,variant:I?U.Primary:U.Neutral,disabled:je([c.Running,c.Resetting,c.Cancelling],n)||s,ref:I||G?v:void 0,children:le(n,[c.Done],"Close")})]})]})}function ys({label:n,enabled:s,setEnabled:a,a11yTitle:t,size:i=$.md,disabled:r=!1,className:j}){return e.jsxs(fe.Group,{as:"div",className:"flex items-center m-1",children:[e.jsxs(fe,{checked:r?!1:s,onChange:a,className:q("flex relative border-secondary-30 rounded-full m-0","shrink-0 focus:outline-none ring-secondary-300 ring-opacity-60 ring-offset ring-offset-secondary-100 focus:border-secondary-500 focus-visible:ring-opacity-75","transition duration-200 ease-in-out",s?"bg-secondary-500":"bg-secondary-20",j,r?"opacity-50 cursor-not-allowed":"cursor-pointer",i===$.sm&&"h-[14px] w-6 focus:ring-1 border",i===$.md&&"h-5 w-10 focus:ring-2 border-2",i===$.lg&&"h-7 w-14 focus:ring-4 border-2"),disabled:r,children:[e.jsx("span",{className:"sr-only",children:t}),e.jsx("span",{"aria-hidden":"true",className:q("pointer-events-none inline-block transform rounded-full shadow-md transition duration-200 ease-in-out","bg-light",i===$.sm&&"h-3 w-3",i===$.md&&"h-4 w-4",i===$.lg&&"h-6 w-6",s&&i===$.sm&&"translate-x-[10px]",s&&i===$.md&&"translate-x-5",s&&i===$.lg&&"translate-x-7")})]}),n!=null&&e.jsx(fe.Label,{className:q("text-xs font-light ml-1 text-neutral-600 dark:text-neutral-400"),children:n})]})}function X({label:n,info:s,enabled:a,disabled:t=!1,setEnabled:i}){return e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("label",{className:"block mb-1 px-3 text-sm font-bold",children:[n,e.jsx("small",{className:"block text-xs text-neutral-500",children:s})]}),e.jsx(ys,{disabled:t,enabled:a,setEnabled:i,size:$.lg})]})}function bs({className:n}){const s=ye(),{skip_tests:a,no_gaps:t,skip_backfill:i,forward_only:r,auto_apply:j,no_auto_categorization:d,restate_models:b,isInitialPlanRun:m,create_from:w}=J(),u=Y(f=>f.environment),g=Y(f=>f.environments),E=ke.getOnlySynchronized(Array.from(g));return e.jsx("li",{className:q("mt-6 mb-6",n),children:e.jsxs("form",{className:"w-full h-full",children:[e.jsxs("fieldset",{className:q("mb-10 mt-6"),children:[e.jsx("h2",{className:"whitespace-nowrap text-xl font-bold mb-1 px-4",children:"Set Dates"}),e.jsx("div",{className:"mt-3",children:e.jsx(F.BackfillDates,{})})]}),e.jsx("fieldset",{className:q("mb-4 mt-6"),children:e.jsx(M,{children:({open:f})=>e.jsxs(e.Fragment,{children:[e.jsxs(M.Button,{className:"flex items-center w-full justify-between rounded-lg text-left text-sm px-4 pt-3 pb-2 bg-neutral-10 hover:bg-theme-darker dark:hover:bg-theme-lighter",children:[e.jsx("h2",{className:"whitespace-nowrap text-xl font-bold mb-1",children:"Additional Options"}),f?e.jsx(de,{className:"h-6 w-6 text-primary-500"}):e.jsx(ue,{className:"h-6 w-6 text-primary-500"})]}),e.jsxs(M.Panel,{className:"px-4 pb-2 text-sm text-neutral-500",children:[e.jsx("div",{className:"mt-3",children:e.jsxs("div",{className:"flex flex-wrap md:flex-nowrap",children:[P(u.isDefault)&&e.jsxs("div",{className:"inline-block m-1 w-full",children:[e.jsx(te.Label,{children:"Create From Environment"}),e.jsx("select",{className:q("w-full bg-neutral-100 border-2 rounded-lg py-2 px-3 text-base leading-4",E.length<2&&"opacity-50 cursor-not-allowed","flex w-full text-prose-lighter bg-theme-lighter border-theme-darker dark:border-theme-lighter dark:text-prose-darker rounded-md","border-2 focus:ring-4 focus:outline-none focus:border-secondary-500","ring-secondary-300 ring-opacity-60 ring-offset ring-offset-secondary-100"),onChange:o=>{s({type:h.PlanOptions,create_from:o.target.value})},disabled:E.length<2,value:w,children:ke.getOnlySynchronized(Array.from(g)).map(o=>e.jsx("option",{value:o.name,children:o.name},o.name))}),e.jsx(te.Info,{children:"The environment to base the plan on rather than local files"})]}),e.jsx(te,{className:"w-full",label:"Restate Models",info:`Restate data for specified models and models
              downstream from the one specified. For production
              environment, all related model versions will have
              their intervals wiped, but only the current
              versions will be backfilled. For development
              environment, only the current model versions will
              be affected`,placeholder:"project.model1, project.model2",disabled:m,value:b??"",onInput:o=>{o.stopPropagation(),s({type:h.PlanOptions,restate_models:o.target.value})}})]})}),e.jsxs("div",{className:"flex flex-wrap md:flex-nowrap w-full mt-3",children:[e.jsxs("div",{className:"w-full md:mr-2",children:[e.jsx("div",{className:"block my-2",children:e.jsx(X,{label:"Skip Tests",info:`Skip tests prior to generating the plan if they
                  are defined`,enabled:!!a,setEnabled:o=>{s({type:h.PlanOptions,skip_tests:o})}})}),e.jsx("div",{className:"block my-2",children:e.jsx(X,{label:"No Gaps",info:`Ensure that new snapshots have no data gaps when
                  comparing to existing snapshots for matching
                  models in the target environment`,enabled:!!t,disabled:m,setEnabled:o=>{s({type:h.PlanOptions,no_gaps:o})}})}),e.jsx("div",{className:"block my-2",children:e.jsx(X,{label:"Skip Backfill",info:"Skip the backfill step",enabled:!!i,disabled:m,setEnabled:o=>{s({type:h.PlanOptions,skip_backfill:o})}})})]}),e.jsxs("div",{className:"w-full md:ml-2",children:[e.jsx("div",{className:"block my-2",children:e.jsx(X,{label:"Forward Only",info:"Create a plan for forward-only changes",enabled:!!r,disabled:m,setEnabled:o=>{s({type:h.PlanOptions,forward_only:o})}})}),e.jsx("div",{className:"block my-2",children:e.jsx(X,{label:"Auto Apply",info:"Automatically apply the plan after it is generated",enabled:!!j,setEnabled:o=>{s({type:h.PlanOptions,auto_apply:o})}})}),e.jsx("div",{className:"block my-2",children:e.jsx(X,{label:"No Auto Categorization",info:"Set category manually",enabled:!!d,disabled:m,setEnabled:o=>{s({type:h.PlanOptions,no_auto_categorization:o})}})})]})]})]})]})})})]})})}function vs({disabled:n=!1}){const s=ye(),{start:a,end:t,isInitialPlanRun:i}=J();return e.jsxs("div",{className:"flex w-full flex-wrap md:flex-nowrap",children:[e.jsx(te,{className:"w-full md:w-[50%]",label:"Start Date (UTC)",info:"The start datetime of the interval",placeholder:"2023-12-13",disabled:n||i,value:a,onInput:r=>{r.stopPropagation(),s({type:h.DateStart,start:r.target.value})}}),e.jsx(te,{className:"w-full md:w-[50%]",label:"End Date (UTC)",info:"The end datetime of the interval",placeholder:"2022-12-13",value:t,disabled:n||i,onInput:r=>{r.stopPropagation(),s({type:h.DateEnd,end:r.target.value})}})]})}function ws({environment:n,isInitialPlanRun:s}){const{start:a,end:t,skip_tests:i,no_gaps:r,skip_backfill:j,forward_only:d,no_auto_categorization:b,restate_models:m,create_from:w}=J(),u=p.useMemo(()=>{if(!n.isDefault)return{start:a,end:s&&ce(m)?void 0:t}},[n,a,t,s,m]);return{planOptions:p.useMemo(()=>n.isDefault||n.isInitial?{skip_tests:i}:{no_gaps:r,skip_backfill:j,forward_only:d,create_from:w,no_auto_categorization:b,skip_tests:i,restate_models:m},[n,r,j,d,w,b,i,m]),planDates:u}}function Ns({isInitialPlanRun:n}){const{start:s,end:a,skip_tests:t,no_gaps:i,skip_backfill:r,forward_only:j,no_auto_categorization:d,restate_models:b,hasBackfills:m,create_from:w,change_categorization:u}=J(),g=p.useMemo(()=>{if(!(n||P(m)))return{start:s,end:a}},[m,s,a,n]),E=p.useMemo(()=>Array.from(u.values()).reduce((f,{category:o,change:_})=>(f[_.model_name]=o.value,f),{}),[u]);return{planDates:g,planOptions:{no_gaps:i,skip_backfill:r,forward_only:j,create_from:w,no_auto_categorization:d,skip_tests:t,restate_models:b},categories:E}}function F({environment:n,isInitialPlanRun:s,initialStartDate:a,initialEndDate:t,disabled:i,onClose:r}){const j=Oe(),d=ye(),{errors:b,removeError:m}=Ee(),{auto_apply:w,hasChanges:u,hasBackfills:g,hasVirtualUpdate:E,testsReportErrors:f}=J(),o=Q(l=>l.state),_=Q(l=>l.action),D=Q(l=>l.activePlan),B=Q(l=>l.setActivePlan),v=Q(l=>l.setAction),A=Q(l=>l.setState),R=p.useRef(null),[I,y]=p.useState(!1),W=Ie(),G=ws({environment:n,isInitialPlanRun:s}),x=Ns({isInitialPlanRun:s}),{refetch:N}=Fe(n.name,G),{refetch:k}=Be(n.name,x),S=p.useCallback(Me(N,1e3,!0),[N]);p.useEffect(()=>{const l=W("tests",T);return n.isInitial&&n.isDefault&&we(),d([{type:h.Dates,start:a,end:t}]),()=>{S.cancel(),l==null||l()}},[]),p.useEffect(()=>{d([{type:h.External,isInitialPlanRun:s}]),s&&d([{type:h.PlanOptions,skip_backfill:!1,forward_only:!1,no_auto_categorization:!1,no_gaps:!1}])},[s]),p.useEffect(()=>{P(I)&&n.isInitial||je([C.Running,C.Applying,C.Cancelling],o)||(P(I)?v(c.Run):P(u||g)&&P(E)||o===C.Finished?v(c.Done):o===C.Failed?v(c.None):v(c.Apply))},[o,I,u,g,E]),p.useEffect(()=>{D!=null&&d({type:h.BackfillProgress,activeBackfill:D})},[D]),p.useEffect(()=>{b.size!==0&&(B(void 0),A(C.Failed))},[b]);function T(l){d([ge(l.ok)?{type:h.TestsReportMessages,testsReportMessages:l}:{type:h.TestsReportErrors,testsReportErrors:l}])}function z(){y(!1),d([{type:h.ResetBackfills},{type:h.ResetChanges},{type:h.Dates,start:a,end:t},{type:h.ResetPlanOptions}])}function L(){v(c.Resetting),m(ie.General),z(),A(C.Init),v(c.Run)}function re(){m(ie.General),m(ie.RunPlan),m(ie.ApplyPlan),r()}function O(){d([{type:h.ResetTestsReport}]),A(C.Cancelling),v(c.Cancelling),ze(j).then(()=>{v(c.Run),A(C.Cancelled)}).catch(l=>{pe(l)?console.log("apiCancelPlanApply","Request aborted by React Query"):(console.log("apiCancelPlanApply",l),L())})}function ve(){v(c.Applying),A(C.Applying),d([{type:h.ResetTestsReport}]),k({throwOnError:!0}).then(({data:l})=>{(l==null?void 0:l.type)===$e.Virtual&&A(C.Finished)}).catch(l=>{pe(l)?console.log("planApply","Request aborted by React Query"):(console.log("planApply",l),L())}).finally(()=>{var l;(l=R==null?void 0:R.current)==null||l.scrollIntoView({behavior:"smooth",block:"start"})})}function we(){d([{type:h.ResetTestsReport}]),v(c.Running),A(C.Running),S({throwOnError:!0}).then(({data:l})=>{d([{type:h.Backfills,backfills:l==null?void 0:l.backfills},{type:h.Changes,...l==null?void 0:l.changes},{type:h.Dates,start:l==null?void 0:l.start,end:l==null?void 0:l.end}]),y(!0),A(C.Init),w?ve():v(c.Run)}).catch(l=>{pe(l)?console.log("planRun","Request aborted by React Query"):(console.log("planRun",l),L())})}const Ae=se(f);return e.jsxs("div",{className:"flex flex-col w-full h-full overflow-hidden pt-6",children:[Ae?e.jsxs(rs,{sizes:se(f)?[50,50]:[30,70],direction:"vertical",snapOffset:0,className:"flex flex-col w-full h-full overflow-hidden",children:[e.jsx(F.Header,{}),e.jsx(F.Wizard,{setRefTasksOverview:R})]}):e.jsxs(e.Fragment,{children:[e.jsx(F.Header,{}),e.jsx(Pe,{}),e.jsx(F.Wizard,{setRefTasksOverview:R})]}),e.jsx(Pe,{}),e.jsx(F.Actions,{disabled:i,planAction:_,apply:ve,run:we,cancel:O,close:re,reset:L})]})}F.Actions=gs;F.Header=xs;F.Wizard=hs;F.StepOptions=bs;F.BackfillDates=vs;const Us=p.memo(function(){const{isPlanOpen:s,setIsPlanOpen:a}=Ee(),t=Y(u=>u.environment),i=Y(u=>u.initialStartDate),r=Y(u=>u.initialEndDate),j=Q(u=>u.setAction),[d,b]=p.useState(!1);function m(){b(!0)}const w=ge(s)&&P(d);return e.jsx(ms,{show:w,afterLeave:()=>{j(c.None),b(!1),a(!1)},children:e.jsx(Se.Panel,{className:"bg-theme border-8 border-r-0 border-secondary-10 dark:border-primary-10 absolute w-[90%] md:w-[75%] xl:w-[60%] h-full right-0 flex flex-col",children:e.jsx(Ze,{children:e.jsx(F,{environment:t,isInitialPlanRun:(t==null?void 0:t.isDefault)==null||ge(t==null?void 0:t.isDefault),disabled:d,initialStartDate:i,initialEndDate:r,onClose:m})})})})});export{Us as default};
