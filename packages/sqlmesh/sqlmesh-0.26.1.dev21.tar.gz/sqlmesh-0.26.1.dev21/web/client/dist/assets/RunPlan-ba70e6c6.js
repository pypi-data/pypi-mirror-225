import{r as p,$ as ue,m as we,n as L,u as N,o as Ee,p as Ne,q as A,d as O,s as S,t as K,v as Ce,j as n,e as E,B as _,w as B,c as F,S as ve,x as De,D as de,y as W,z as ke}from"./index-ff1743b2.js";import{I as Me}from"./Input-f36d2f96.js";import{M as z,C as Ae}from"./ModalConfirmation-ccba14f2.js";import{E as M}from"./context-d92d8d28.js";import{F as Te,P as me}from"./PlanChangePreview-e614eaad.js";import{S as pe,D as V,y as q,H as Fe,o as R,c as $e,u as ge,d as H,X as G,I as te,p as ye,n as Le,C as ze,l as X,h as Oe,T as _e,a as I,r as Be,b as ee,_ as Qe,M as fe,e as be,f as Ue,$ as Ie}from"./transition-65d8b341.js";import{b as Ke,u as He,a as C,x as Ve,C as qe}from"./use-text-value-e49d8c44.js";import{s as Ge,k as he}from"./popover-a777e0dc.js";import"./dialog-9c75ff50.js";import"./context-e4b03e9a.js";import"./_commonjs-dynamic-modules-302442b1.js";import"./ModelLineage-29146895.js";import"./Graph-12643de8.js";import"./extends-98964cd2.js";import"./use-controllable-2f233ce4.js";import"./disclosure-8eea5612.js";var Ye=(e=>(e[e.Open=0]="Open",e[e.Closed=1]="Closed",e))(Ye||{}),Je=(e=>(e[e.Pointer=0]="Pointer",e[e.Other=1]="Other",e))(Je||{}),We=(e=>(e[e.OpenMenu=0]="OpenMenu",e[e.CloseMenu=1]="CloseMenu",e[e.GoToItem=2]="GoToItem",e[e.Search=3]="Search",e[e.ClearSearch=4]="ClearSearch",e[e.RegisterItem=5]="RegisterItem",e[e.UnregisterItem=6]="UnregisterItem",e))(We||{});function Z(e,r=a=>a){let a=e.activeItemIndex!==null?e.items[e.activeItemIndex]:null,s=Ue(r(e.items.slice()),u=>u.dataRef.current.domRef.current),i=a?s.indexOf(a):null;return i===-1&&(i=null),{items:s,activeItemIndex:i}}let Xe={1(e){return e.menuState===1?e:{...e,activeItemIndex:null,menuState:1}},0(e){return e.menuState===0?e:{...e,__demoMode:!1,menuState:0}},2:(e,r)=>{var a;let s=Z(e),i=Ve(r,{resolveItems:()=>s.items,resolveActiveIndex:()=>s.activeItemIndex,resolveId:u=>u.id,resolveDisabled:u=>u.dataRef.current.disabled});return{...e,...s,searchQuery:"",activeItemIndex:i,activationTrigger:(a=r.trigger)!=null?a:1}},3:(e,r)=>{let a=e.searchQuery!==""?0:1,s=e.searchQuery+r.value.toLowerCase(),i=(e.activeItemIndex!==null?e.items.slice(e.activeItemIndex+a).concat(e.items.slice(0,e.activeItemIndex+a)):e.items).find(l=>{var t;return((t=l.dataRef.current.textValue)==null?void 0:t.startsWith(s))&&!l.dataRef.current.disabled}),u=i?e.items.indexOf(i):-1;return u===-1||u===e.activeItemIndex?{...e,searchQuery:s}:{...e,searchQuery:s,activeItemIndex:u,activationTrigger:1}},4(e){return e.searchQuery===""?e:{...e,searchQuery:"",searchActiveItemIndex:null}},5:(e,r)=>{let a=Z(e,s=>[...s,{id:r.id,dataRef:r.dataRef}]);return{...e,...a}},6:(e,r)=>{let a=Z(e,s=>{let i=s.findIndex(u=>u.id===r.id);return i!==-1&&s.splice(i,1),s});return{...e,...a,activationTrigger:1}}},ne=p.createContext(null);ne.displayName="MenuContext";function Y(e){let r=p.useContext(ne);if(r===null){let a=new Error(`<${e} /> is missing a parent <Menu /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(a,Y),a}return r}function Ze(e,r){return ge(r.type,Xe,e,r)}let et=p.Fragment;function tt(e,r){let{__demoMode:a=!1,...s}=e,i=p.useReducer(Ze,{__demoMode:a,menuState:a?0:1,buttonRef:p.createRef(),itemsRef:p.createRef(),items:[],searchQuery:"",activeItemIndex:null,activationTrigger:1}),[{menuState:u,itemsRef:l,buttonRef:t},c]=i,v=q(r);Fe([t,l],(j,y)=>{var x;c({type:1}),Oe(y,_e.Loose)||(j.preventDefault(),(x=t.current)==null||x.focus())},u===0);let b=R(()=>{c({type:1})}),m=p.useMemo(()=>({open:u===0,close:b}),[u,b]),h={ref:v};return ue.createElement(ne.Provider,{value:i},ue.createElement($e,{value:ge(u,{0:H.Open,1:H.Closed})},G({ourProps:h,theirProps:s,slot:m,defaultTag:et,name:"Menu"})))}let nt="button";function st(e,r){var a;let s=te(),{id:i=`headlessui-menu-button-${s}`,...u}=e,[l,t]=Y("Menu.Button"),c=q(l.buttonRef,r),v=ye(),b=R(x=>{switch(x.key){case I.Space:case I.Enter:case I.ArrowDown:x.preventDefault(),x.stopPropagation(),t({type:0}),v.nextFrame(()=>t({type:2,focus:C.First}));break;case I.ArrowUp:x.preventDefault(),x.stopPropagation(),t({type:0}),v.nextFrame(()=>t({type:2,focus:C.Last}));break}}),m=R(x=>{switch(x.key){case I.Space:x.preventDefault();break}}),h=R(x=>{if(Be(x.currentTarget))return x.preventDefault();e.disabled||(l.menuState===0?(t({type:1}),v.nextFrame(()=>{var w;return(w=l.buttonRef.current)==null?void 0:w.focus({preventScroll:!0})})):(x.preventDefault(),t({type:0})))}),j=p.useMemo(()=>({open:l.menuState===0}),[l]),y={ref:c,id:i,type:Ge(e,l.buttonRef),"aria-haspopup":"menu","aria-controls":(a=l.itemsRef.current)==null?void 0:a.id,"aria-expanded":e.disabled?void 0:l.menuState===0,onKeyDown:b,onKeyUp:m,onClick:h};return G({ourProps:y,theirProps:u,slot:j,defaultTag:nt,name:"Menu.Button"})}let rt="div",at=pe.RenderStrategy|pe.Static;function it(e,r){var a,s;let i=te(),{id:u=`headlessui-menu-items-${i}`,...l}=e,[t,c]=Y("Menu.Items"),v=q(t.itemsRef,r),b=Le(t.itemsRef),m=ye(),h=ze(),j=(()=>h!==null?(h&H.Open)===H.Open:t.menuState===0)();p.useEffect(()=>{let o=t.itemsRef.current;o&&t.menuState===0&&o!==(b==null?void 0:b.activeElement)&&o.focus({preventScroll:!0})},[t.menuState,t.itemsRef,b]),Te({container:t.itemsRef.current,enabled:t.menuState===0,accept(o){return o.getAttribute("role")==="menuitem"?NodeFilter.FILTER_REJECT:o.hasAttribute("role")?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT},walk(o){o.setAttribute("role","none")}});let y=R(o=>{var D,P;switch(m.dispose(),o.key){case I.Space:if(t.searchQuery!=="")return o.preventDefault(),o.stopPropagation(),c({type:3,value:o.key});case I.Enter:if(o.preventDefault(),o.stopPropagation(),c({type:1}),t.activeItemIndex!==null){let{dataRef:g}=t.items[t.activeItemIndex];(P=(D=g.current)==null?void 0:D.domRef.current)==null||P.click()}be(t.buttonRef.current);break;case I.ArrowDown:return o.preventDefault(),o.stopPropagation(),c({type:2,focus:C.Next});case I.ArrowUp:return o.preventDefault(),o.stopPropagation(),c({type:2,focus:C.Previous});case I.Home:case I.PageUp:return o.preventDefault(),o.stopPropagation(),c({type:2,focus:C.First});case I.End:case I.PageDown:return o.preventDefault(),o.stopPropagation(),c({type:2,focus:C.Last});case I.Escape:o.preventDefault(),o.stopPropagation(),c({type:1}),ee().nextFrame(()=>{var g;return(g=t.buttonRef.current)==null?void 0:g.focus({preventScroll:!0})});break;case I.Tab:o.preventDefault(),o.stopPropagation(),c({type:1}),ee().nextFrame(()=>{Qe(t.buttonRef.current,o.shiftKey?fe.Previous:fe.Next)});break;default:o.key.length===1&&(c({type:3,value:o.key}),m.setTimeout(()=>c({type:4}),350));break}}),x=R(o=>{switch(o.key){case I.Space:o.preventDefault();break}}),w=p.useMemo(()=>({open:t.menuState===0}),[t]),T={"aria-activedescendant":t.activeItemIndex===null||(a=t.items[t.activeItemIndex])==null?void 0:a.id,"aria-labelledby":(s=t.buttonRef.current)==null?void 0:s.id,id:u,onKeyDown:y,onKeyUp:x,role:"menu",tabIndex:0,ref:v};return G({ourProps:T,theirProps:l,slot:w,defaultTag:rt,features:at,visible:j,name:"Menu.Items"})}let ot=p.Fragment;function lt(e,r){let a=te(),{id:s=`headlessui-menu-item-${a}`,disabled:i=!1,...u}=e,[l,t]=Y("Menu.Item"),c=l.activeItemIndex!==null?l.items[l.activeItemIndex].id===s:!1,v=p.useRef(null),b=q(r,v);X(()=>{if(l.__demoMode||l.menuState!==0||!c||l.activationTrigger===0)return;let g=ee();return g.requestAnimationFrame(()=>{var $,d;(d=($=v.current)==null?void 0:$.scrollIntoView)==null||d.call($,{block:"nearest"})}),g.dispose},[l.__demoMode,v,c,l.menuState,l.activationTrigger,l.activeItemIndex]);let m=Ke(v),h=p.useRef({disabled:i,domRef:v,get textValue(){return m()}});X(()=>{h.current.disabled=i},[h,i]),X(()=>(t({type:5,id:s,dataRef:h}),()=>t({type:6,id:s})),[h,s]);let j=R(()=>{t({type:1})}),y=R(g=>{if(i)return g.preventDefault();t({type:1}),be(l.buttonRef.current)}),x=R(()=>{if(i)return t({type:2,focus:C.Nothing});t({type:2,focus:C.Specific,id:s})}),w=He(),T=R(g=>w.update(g)),o=R(g=>{w.wasMoved(g)&&(i||c||t({type:2,focus:C.Specific,id:s,trigger:0}))}),D=R(g=>{w.wasMoved(g)&&(i||c&&t({type:2,focus:C.Nothing}))}),P=p.useMemo(()=>({active:c,disabled:i,close:j}),[c,i,j]);return G({ourProps:{id:s,ref:b,role:"menuitem",tabIndex:i===!0?void 0:-1,"aria-disabled":i===!0?!0:void 0,disabled:void 0,onClick:y,onFocus:x,onPointerEnter:T,onMouseEnter:T,onPointerMove:o,onMouseMove:o,onPointerLeave:D,onMouseLeave:D},theirProps:u,slot:P,defaultTag:ot,name:"Menu.Item"})}let ct=V(tt),ut=V(st),dt=V(it),mt=V(lt),Q=Object.assign(ct,{Button:ut,Items:dt,Item:mt});function Mt(){const{errors:e,setIsPlanOpen:r}=we(),a=L(f=>f.state),s=L(f=>f.action),i=L(f=>f.setState),u=L(f=>f.setAction),l=L(f=>f.setActivePlan),t=N(f=>f.environment),c=N(f=>f.environments),v=N(f=>f.setInitialDates),b=N(f=>f.hasSynchronizedEnvironments),[m,h]=p.useState(!1),[j,y]=p.useState(!1),[x,w]=p.useState(),[T,o]=p.useState(!1),{refetch:D,data:P,isFetching:g}=Ee(t.name,{planOptions:{skip_tests:!0}}),$=p.useCallback(Ne(D,1e3,!0),[D]),d=p.useMemo(()=>t.isDefault?{headline:"Running Plan Directly On Prod Environment!",description:"Are you sure you want to run your changes directly on prod? Safer choice will be to select or add new environment first.",yesText:`Yes, Run ${t.name}`,noText:"No, Cancel",action(){J()}}:void 0,[t]);p.useEffect(()=>{T&&(J(),o(!1)),!A(t.isSynchronized)&&$()},[t]),p.useEffect(()=>{var f,k,re,ae,ie,oe,le,ce;P!=null&&(w(P),v(P.start,P.end),h([(f=P.changes)==null?void 0:f.added,(k=P.changes)==null?void 0:k.removed,(ae=(re=P.changes)==null?void 0:re.modified)==null?void 0:ae.direct,(oe=(ie=P.changes)==null?void 0:ie.modified)==null?void 0:oe.indirect,(ce=(le=P.changes)==null?void 0:le.modified)==null?void 0:ce.metadata].some(O)))},[P]);function J(){l(void 0),i(S.Init),u(K.Run),r(!0)}const je=e.size>0,Se=(A(t.isDefault)||b())&&(A(t.isDefault)||A(t.isInitial)),Re=Ce([S.Applying,S.Running,S.Cancelling],a),se=je||g||s!==K.None||a===S.Applying||a===S.Running||a===S.Cancelling;return n.jsxs("div",{className:E("flex items-center",t==null&&"opacity-50 pointer-events-none cursor-not-allowed"),children:[n.jsxs("div",{className:"flex items-center relative",children:[n.jsxs(_,{className:E("mx-0",A(t.isInitial&&t.isDefault)&&"rounded-none rounded-l-lg border-r"),disabled:se,variant:B.Alternative,size:F.sm,onClick:f=>{f.stopPropagation(),t.isDefault&&A(t.isInitial)?y(!0):J()},children:[Re&&n.jsx(ve,{className:"w-3 h-3 mr-1"}),n.jsx("span",{className:"inline-block",children:ft(a,s)})]}),Se&&n.jsx(xe,{className:"rounded-none rounded-r-lg border-l mx-0",environment:t,disabled:se})]}),n.jsx(pt,{environment:t,plan:x,isLoading:g,hasChanges:m}),n.jsxs(z,{show:j,onClose:()=>{},children:[n.jsxs(z.Main,{children:[(d==null?void 0:d.headline)!=null&&n.jsx(z.Headline,{children:d==null?void 0:d.headline}),(d==null?void 0:d.description)!=null&&n.jsx(z.Description,{children:d==null?void 0:d.description}),n.jsxs("div",{className:"mt-5 pt-4",children:[n.jsx("h4",{className:"mb-2",children:`${c.size>1?"Select or ":""}Add Environment`}),n.jsxs("div",{className:"flex items-center relative",children:[c.size>1&&n.jsx(xe,{className:"mr-2",side:"left",environment:t,showAddEnvironemnt:!1,onSelect:()=>{o(!0),y(!1)},size:F.md,disabled:g||s!==K.None||a===S.Applying||a===S.Cancelling}),n.jsx(Pe,{className:"w-full",size:F.md,onAdd:()=>{o(!0),y(!1)}})]})]})]}),n.jsxs(z.Actions,{children:[n.jsx(_,{className:"font-bold",size:"md",variant:B.Primary,onClick:f=>{var k;f.stopPropagation(),(k=d==null?void 0:d.action)==null||k.call(d),y(!1)},children:(d==null?void 0:d.yesText)??"Confirm"}),n.jsx(_,{size:"md",variant:B.Neutral,onClick:f=>{var k;f.stopPropagation(),(k=d==null?void 0:d.cancel)==null||k.call(d),y(!1)},children:(d==null?void 0:d.noText)??"Cancel"})]})]})]})}function pt({isLoading:e,hasChanges:r,environment:a,plan:s}){var i,u,l,t;return n.jsx("span",{className:"flex align-center h-full w-full",children:n.jsx(n.Fragment,{children:e?n.jsxs("span",{className:"flex items-center ml-2",children:[n.jsx(ve,{className:"w-3 h-3 mr-1"}),n.jsx("span",{className:"inline-block text-xs text-neutral-500",children:"Checking..."})]}):n.jsxs(n.Fragment,{children:[a.isInitial&&a.isLocal&&n.jsx("span",{title:"New",className:"block ml-1 px-2 first-child:ml-0 rounded-full bg-success-10 text-success-500 text-xs text-center font-bold",children:"New"}),[r,e,a.isLocal].every(A)&&n.jsx("span",{title:"Latest",className:"block ml-1 px-2 first-child:ml-0 rounded-full bg-neutral-10 text-xs text-center",children:n.jsx("span",{children:"Latest"})}),O((i=s==null?void 0:s.changes)==null?void 0:i.added)&&n.jsx(U,{headline:"Added Models",type:M.Add,changes:s.changes.added}),O((u=s==null?void 0:s.changes)==null?void 0:u.modified.direct)&&n.jsx(U,{headline:"Direct Changes",type:M.Direct,changes:s.changes.modified.direct.map(({model_name:c})=>c)}),O((l=s==null?void 0:s.changes)==null?void 0:l.modified.indirect)&&n.jsx(U,{headline:"Indirectly Modified",type:M.Indirect,changes:s.changes.modified.indirect.map(c=>c.model_name)}),O((t=s==null?void 0:s.changes)==null?void 0:t.removed)&&n.jsx(U,{headline:"Removed Models",type:M.Remove,changes:s.changes.removed})]})})})}function xe({onSelect:e,environment:r,disabled:a,side:s=W.Right,className:i,showAddEnvironemnt:u=!0,size:l=F.sm}){const t=N(m=>m.environments),c=N(m=>m.setEnvironment),v=N(m=>m.removeLocalEnvironment),b=De(Q.Button);return n.jsx(Q,{children:({close:m})=>n.jsxs(n.Fragment,{children:[n.jsxs(b,{variant:B.Alternative,size:l,disabled:a,className:E(i),children:[n.jsx("span",{className:E("block overflow-hidden truncate",(r.isLocal||a)&&"text-neutral-500",r.isSynchronized&&"text-primary-500"),children:r.name}),n.jsx("span",{className:"pointer-events-none inset-y-0 right-0 flex items-center pl-2",children:n.jsx(qe,{className:"h-4 w-4","aria-hidden":"true"})})]}),n.jsx(Ie,{as:p.Fragment,leave:"transition ease-in duration-100",leaveFrom:"opacity-100",leaveTo:"opacity-0",children:n.jsxs("div",{className:E("absolute top-9 overflow-hidden shadow-xl bg-theme border-2 border-primary-20 rounded-md flex flex-col z-10",s===W.Left&&"left-0",s===W.Right&&"right-0"),children:[n.jsxs(Q.Items,{className:"overflow-auto max-h-80 py-2 scrollbar scrollbar--vertical",children:[Array.from(t).map(h=>n.jsx(Q.Item,{children:({active:j})=>n.jsxs("div",{onClick:y=>{y.stopPropagation(),c(h),e==null||e()},className:E("flex justify-between items-center px-4 py-1 cursor-pointer overflow-auto",j&&"bg-primary-10",h===r&&"pointer-events-none cursor-default bg-secondary-10"),children:[n.jsxs("div",{className:"flex items-start",children:[n.jsx(Ae,{className:E("w-4 h-4 text-primary-500 mt-1",j&&"opacity-10",h!==r&&"opacity-0")}),n.jsxs("span",{className:"block",children:[n.jsxs("span",{className:"flex items-center",children:[n.jsx("span",{className:E("block truncate ml-2",h.isSynchronized&&"text-primary-500"),children:h.name}),n.jsxs("small",{className:"block ml-2",children:["(",h.type,")"]})]}),h.isDefault&&n.jsx("span",{className:"flex ml-2",children:n.jsx("small",{className:"text-xs text-neutral-500",children:"Default Environment"})})]})]}),h.isLocal&&h!==r&&n.jsx(_,{className:"my-0 mx-0",size:F.xs,variant:B.Neutral,onClick:y=>{y.stopPropagation(),v(h)},children:"-"})]})},h.name)),u&&n.jsxs(n.Fragment,{children:[n.jsx(de,{}),n.jsx(Pe,{onAdd:m,className:"mt-2 px-2"})]})]}),n.jsx(de,{})]})})]})})}function Pe({onAdd:e,className:r,label:a="Add",size:s=F.sm}){const i=N(m=>m.getNextEnvironment),u=N(m=>m.isExistingEnvironment),l=N(m=>m.addLocalEnvironment),[t,c]=p.useState(""),[v,b]=p.useState(i().name);return n.jsxs("div",{className:E("flex w-full items-center",r),children:[n.jsx(Me,{className:"my-0 mx-0 mr-4 min-w-[10rem] w-full",size:s,placeholder:"Environment",value:t,onInput:m=>{m.stopPropagation(),c(m.target.value)}}),n.jsx(_,{className:"my-0 mx-0 font-bold",size:s,disabled:ke(t)||u(t),onClick:m=>{m.stopPropagation(),l(t,v),c(""),b(i().name),e==null||e()},children:a})]})}function U({headline:e,type:r,changes:a}){const[s,i]=p.useState(!1);return n.jsx(he,{onMouseEnter:()=>{i(!0)},onMouseLeave:()=>{i(!1)},className:"relative flex",children:()=>n.jsxs(n.Fragment,{children:[n.jsx("span",{className:E("inline-block ml-1 px-2 rounded-full text-xs font-bold text-neutral-100 cursor-default border border-inherit",r===M.Add&&"bg-success-500 border-success-500",r===M.Remove&&"bg-danger-500 border-danger-500",r===M.Direct&&"bg-secondary-500 border-secondary-500",r===M.Indirect&&"bg-warning-500 border-warning-500",r==="metadata"&&"bg-neutral-500 border-neutral-500"),children:a.length}),n.jsx(Ie,{show:s,as:p.Fragment,enter:"transition ease-out duration-200",enterFrom:"opacity-0 translate-y-1",enterTo:"opacity-100 translate-y-0",leave:"transition ease-in duration-150",leaveFrom:"opacity-100 translate-y-0",leaveTo:"opacity-0 translate-y-1",children:n.jsx(he.Panel,{className:"absolute right-1 z-10 mt-8 transform flex p-2 bg-theme-lighter shadow-xl focus:ring-2 ring-opacity-5 rounded-lg ",children:n.jsx(me,{headline:e,type:r,className:"w-full h-full max-h-[40vh] overflow-hidden overflow-y-auto ",children:n.jsx(me.Default,{type:r,changes:a})})})})]})})}function ft(e,r){return e===S.Running?"Running Plan...":e===S.Applying?"Applying Plan...":e===S.Cancelling?"Cancelling Plan...":r===K.None?"Run Plan":"Setting Plan..."}export{Mt as default};
